<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using the BEAST2 - TransPhylo Pipeline with a Sample of BEAST2 Iterations (Posterior Trees) â€¢ beast2tpPipeline</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using the BEAST2 - TransPhylo Pipeline with a Sample of BEAST2 Iterations (Posterior Trees)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">beast2tpPipeline</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Home"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/mcc_tree_pipeline.html">Using the BEAST2 - TransPhylo Pipeline with Maximum Clade Credibility Trees</a></li>
    <li><a class="dropdown-item" href="../articles/tree_sample_pipeline.html">Using the BEAST2 - TransPhylo Pipeline with a Sample of BEAST2 Iterations (Posterior Trees)</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jessalynnsebastian/beast2tpPipeline" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using the BEAST2 - TransPhylo Pipeline with a Sample of BEAST2 Iterations (Posterior Trees)</h1>
            
      

      <div class="d-none name"><code>tree_sample_pipeline.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will walk you through the process of using the
<code>beast2tpPipeline</code> package to create SNP clusters from a set
of fasta files, create xml files for each cluster, run BEAST2, run
TransPhylo on the BEAST2 results, and then do some kind of regression on
the probabilities assigned by TransPhylo.</p>
<p>After running BEAST2, we have a set of posterior trees for each
cluster. With this package we can do two things:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Create a <a href="https://en.wikipedia.org/wiki/Maximum_clade_credibility_tree#:~:text=A%20maximum%20clade%20credibility%20tree,of%20the%20sampled%20posterior%20trees.0" class="external-link">maximum
clade credibility (MCC) tree</a> from the posterior trees, and run
TransPhylo multitree on the MCC trees, sharing some parameters that can
be simultaneously estimated</strong>. The MCC tree is a single tree that
attempts to summarize the posterior trees, like a mean or median when
posterior samples are values from the real line. With this method we
take one tree that summarizes the posterior trees for each cluster, and
run TransPhylo on all of them as if they are the true phylogenetic
trees.</li>
<li>
<strong>Subsample some number of trees from the BEAST2 posterior
tree samples for each cluster, and run TransPhylo on a sample of trees
for each cluster, rather than one summary tree</strong>. This has the
advantage of accounting for some of the phylogenetic uncertainty in the
BEAST2 trees, rather than assuming that one tree is the truth. However,
it is computationally more expensive: instead of one TransPhylo run on
all the clusters, we have to run TransPhylo on each cluster separately,
each time with a decently-sized set of trees. This should be run on a
computing cluster. Additionally, via this method, parameter sharing is
not possible.</li>
</ol>
<p>In this vignette, we will use this package to do (2). For the
vignette on (1), see <a href="mcc_tree_pipeline.html">Using the BEAST2 -
TransPhylo Pipeline with Maximum Clade Credibility Trees</a>.</p>
<p>First, load the package with <code>library</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jessalynnsebastian.github.io/beast2tpPipeline/">beast2tpPipeline</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-for-this-example">Data for this Example<a class="anchor" aria-label="anchor" href="#data-for-this-example"></a>
</h2>
<p>This package comes with data collected from the Kopanyo study, in
which tuberculosis (TB) samples were collected in two regions of
Botswana, a country with high prevalence of both TB and human
immodeficiency virus (HIV). Read more about the study <a href="https://bmjopen.bmj.com/content/6/5/e010046" class="external-link">here</a>.</p>
<p>These data contain 4 fasta files, one for each lineage of TB. Each
fasta file contains aligned TB sequences from study participants. There
is also metadata available for these samples, including things like HIV
status, age, gender, sample collection date, and a handful of other
variables.</p>
<p>Suppose we are interested in using these TB sequences to draw
inference on whether having HIV makes an individual more likely to
transmit TB to someone else.</p>
</div>
<div class="section level2">
<h2 id="creating-single-nucleotide-polymorphism-snp-clusters">Creating Single Nucleotide Polymorphism (SNP) Clusters<a class="anchor" aria-label="anchor" href="#creating-single-nucleotide-polymorphism-snp-clusters"></a>
</h2>
<p>First, read the fasta files and the metadata into <code>R</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fasta_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"kopanyo"</span>, package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                          pattern <span class="op">=</span> <span class="st">".fasta"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">tb_sequences</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fasta_files</span>, <span class="fu">ape</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ape/man/read.dna.html" class="external-link">read.dna</a></span>, format <span class="op">=</span> <span class="st">"fasta"</span>,</span>
<span>                       as.character <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"kopanyo"</span>, package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                       pattern <span class="op">=</span> <span class="st">".csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span></code></pre></div>
<p>We can take a peek at the data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   SampleID Lineage genderf1 agenew hivfinal_new gMixture  collectdt smokef1</span></span>
<span><span class="co">## 1 BTB-1139       1        1     52            1        0 2014-07-30       1</span></span>
<span><span class="co">## 2 BTB-1146       1        1     43            1        1 2014-08-05       1</span></span>
<span><span class="co">## 3 BTB-1705       1        1     70            2        1 2015-06-10       1</span></span>
<span><span class="co">## 4  BTB-175       1        2     19            1        1 2013-01-16       2</span></span>
<span><span class="co">## 5 BTB-1774       1        1     38            1        1 2015-07-30       2</span></span>
<span><span class="co">## 6 BTB-1894       1        1     15           NA        1 2015-10-16       2</span></span>
<span><span class="co">##   tb_everf3 alcohol_excess Lineage_detailed</span></span>
<span><span class="co">## 1         2              2            1.1.2</span></span>
<span><span class="co">## 2         2              1            1.1.2</span></span>
<span><span class="co">## 3         1              2            1.1.2</span></span>
<span><span class="co">## 4         1              2            1.1.2</span></span>
<span><span class="co">## 5         1              2            1.1.2</span></span>
<span><span class="co">## 6         1              2            1.1.2</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1426   11</span></span></code></pre>
<p>Notice that we have 1426 sequences and corresponding metadata. It
would be very computationally intensive to run BEAST2 on all of these
sequences simultaneously. Instead, we will create clusters of similar
sequences and run BEAST2 on each cluster separately. To create clusters,
we will use SNP thresholding.</p>
<p>SNPs are single nucleotide polymorphisms, which are single base pair
differences between sequences. We can use these differences to group
sequences into clusters that are more likely to be closely related to
each other. We will use the <code>transcluster</code> package to do
this. <code>transcluster</code> is a package developed alongside the
paper <a href="https://academic.oup.com/mbe/article/36/3/587/5300248" class="external-link">Beyond the
SNP Threshold: Identifying Outbreak Clusters Using Inferred
Transmissions</a>. It was built to handle both plain SNP thresholding to
create clusters, and also clustering based on likely transmissions. Here
we will use the former, as it is simpler and more commonly used, but the
latter is still available in the function.</p>
<p>To assign sequences to their clusters based on SNPs, we will use
<code>assign_snp_clusters</code>, which is a wrapper around some
<code>transcluster</code> functions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get collection dates by lineage</span></span>
<span><span class="va">collectdts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">metadata</span>, <span class="va">metadata</span><span class="op">$</span><span class="va">Lineage</span><span class="op">)</span></span>
<span><span class="co"># Create named vectors of dates, as required by the function</span></span>
<span><span class="va">collectdts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">collectdts</span>, <span class="kw">function</span><span class="op">(</span><span class="va">meta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">meta</span><span class="op">$</span><span class="va">collectdt</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">meta</span><span class="op">$</span><span class="va">SampleID</span></span>
<span>  <span class="va">dates</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply the function to each lineage of sequences</span></span>
<span><span class="va">cluster_assignments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">assign_snp_clusters</span>,</span>
<span>                              <span class="co"># `seqs` is a matrix of sequences</span></span>
<span>                              seqs <span class="op">=</span> <span class="va">tb_sequences</span>,</span>
<span>                              <span class="co"># `collectdts` is a named list of vectors of collection dates</span></span>
<span>                              <span class="co"># where the elements are collection dates and the names are sample IDs  </span></span>
<span>                              collectdts <span class="op">=</span> <span class="va">collectdts</span>,</span>
<span>                              threshold <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                              SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Creating SNP-based clusters</span></span>
<span><span class="co">## Creating SNP-based clusters</span></span>
<span><span class="co">## Creating SNP-based clusters</span></span>
<span><span class="co">## Creating SNP-based clusters</span></span></code></pre>
<p>Computing the distance matrix for large clusters can take time, so if
you already have a distance matrix saved, you can pass it to
<code>assign_snp_clusters</code> with the <code>dist_matrix</code>
argument.</p>
<p>Now we have:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rename clusters to include lineage</span></span>
<span><span class="va">cluster_assignments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">cluster_assignments</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster_assignments</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"lineage"</span>, <span class="va">i</span>, <span class="st">"_"</span>, <span class="va">cluster_assignments</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_name</span><span class="op">)</span></span>
<span>  <span class="va">cluster_assignments</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look at the cluster assignments</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">cluster_assignments</span>, <span class="va">head</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##   sample_id      cluster_name  collectdt</span></span>
<span><span class="co">## 1  BTB-1023 lineage1_cluster1 2014-05-13</span></span>
<span><span class="co">## 2  BTB-1058 lineage1_cluster2 2014-06-04</span></span>
<span><span class="co">## 3  BTB-1088 lineage1_cluster3 2014-06-25</span></span>
<span><span class="co">## 4    BTB-10 lineage1_cluster4 2012-09-10</span></span>
<span><span class="co">## 5  BTB-1133 lineage1_cluster5 2014-07-25</span></span>
<span><span class="co">## 6  BTB-1139 lineage1_cluster6 2014-07-30</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##   sample_id      cluster_name  collectdt</span></span>
<span><span class="co">## 1  BTB-1000 lineage2_cluster1 2014-04-28</span></span>
<span><span class="co">## 2  BTB-1014 lineage2_cluster2 2014-05-07</span></span>
<span><span class="co">## 3  BTB-1025 lineage2_cluster3 2014-05-13</span></span>
<span><span class="co">## 4  BTB-1115 lineage2_cluster4 2014-07-16</span></span>
<span><span class="co">## 5  BTB-1123 lineage2_cluster5 2014-07-16</span></span>
<span><span class="co">## 6  BTB-1160 lineage2_cluster6 2014-08-12</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##   sample_id      cluster_name  collectdt</span></span>
<span><span class="co">## 1   BTB-119 lineage3_cluster1 2012-12-03</span></span>
<span><span class="co">## 2  BTB-1259 lineage3_cluster2 2014-09-25</span></span>
<span><span class="co">## 3  BTB-1344 lineage3_cluster3 2014-11-11</span></span>
<span><span class="co">## 4  BTB-1410 lineage3_cluster1 2014-12-10</span></span>
<span><span class="co">## 5   BTB-155 lineage3_cluster1 2013-01-07</span></span>
<span><span class="co">## 6  BTB-1698 lineage3_cluster1 2015-06-08</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">##   sample_id      cluster_name  collectdt</span></span>
<span><span class="co">## 1  BTB-1001 lineage4_cluster1 2014-04-28</span></span>
<span><span class="co">## 2  BTB-1003 lineage4_cluster2 2014-04-25</span></span>
<span><span class="co">## 3  BTB-1005 lineage4_cluster3 2014-04-30</span></span>
<span><span class="co">## 4  BTB-1007 lineage4_cluster4 2014-05-02</span></span>
<span><span class="co">## 5  BTB-1009 lineage4_cluster5 2014-05-05</span></span>
<span><span class="co">## 6  BTB-1010 lineage4_cluster6 2014-05-05</span></span></code></pre>
<p>Next, we will create the actual BEAST2 clusters using the
<code>create_BEAST2_clusters</code> function. We will take the
sequences, split them into separate objects, and keep only the SNPs
(sites that are the same across all sequences will not matter to
BEAST2).</p>
<p>We will discard clusters with fewer than 4 sequences, and clusters
with fewer than 8 SNPs. We also add constant sites to the sequences, to
deal with ascertainment bias in BEAST2 due to the fact that we are only
keeping the SNPs.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For each lineage, use the cluster assignments to put the sequences</span></span>
<span><span class="co"># into clusters</span></span>
<span><span class="va">snp_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tb_sequences</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">lineage_index</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Pull the sequences and cluster assignments for this lineage</span></span>
<span>  <span class="va">tb_seq_lineage</span> <span class="op">&lt;-</span> <span class="va">tb_sequences</span><span class="op">[[</span><span class="va">lineage_index</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">cluster_assignments_lineage</span> <span class="op">&lt;-</span> <span class="va">cluster_assignments</span><span class="op">[[</span><span class="va">lineage_index</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/create_BEAST2_clusters.html">create_BEAST2_clusters</a></span><span class="op">(</span>seqs <span class="op">=</span> <span class="va">tb_seq_lineage</span>,</span>
<span>                         cluster_assignments <span class="op">=</span> <span class="va">cluster_assignments_lineage</span>,</span>
<span>                         min_cluster_size <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                         min_varsites <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                         snps_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         constant_sites <span class="op">=</span> <span class="st">"acgt"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look at the clusters from the first lineage</span></span>
<span><span class="va">snp_matrices</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $lineage1_cluster6</span></span>
<span><span class="co">##          [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]</span></span>
<span><span class="co">## BTB-1139 "a"  "c"  "g"  "t"  "c"  "c"  "g"  "c"  "t"  "c"   "c"   "t"   "c"  </span></span>
<span><span class="co">## BTB-1146 "a"  "c"  "g"  "t"  "a"  "t"  "g"  "c"  "t"  "t"   "t"   "t"   "c"  </span></span>
<span><span class="co">## BTB-1705 "a"  "c"  "g"  "t"  "c"  "c"  "g"  "t"  "t"  "c"   "c"   "t"   "c"  </span></span>
<span><span class="co">## BTB-175  "a"  "c"  "g"  "t"  "c"  "c"  "g"  "c"  "t"  "c"   "c"   "c"   "t"  </span></span>
<span><span class="co">## BTB-1774 "a"  "c"  "g"  "t"  "c"  "c"  "c"  "c"  "t"  "c"   "c"   "c"   "t"  </span></span>
<span><span class="co">## BTB-262  "a"  "c"  "g"  "t"  "c"  "c"  "g"  "c"  "t"  "c"   "c"   "t"   "c"  </span></span>
<span><span class="co">## BTB-604  "a"  "c"  "g"  "t"  "c"  "c"  "g"  "c"  "c"  "c"   "c"   "t"   "c"  </span></span>
<span><span class="co">##          [,14] [,15] [,16] [,17] [,18]</span></span>
<span><span class="co">## BTB-1139 "g"   "g"   "c"   "c"   "g"  </span></span>
<span><span class="co">## BTB-1146 "g"   "g"   "c"   "c"   "a"  </span></span>
<span><span class="co">## BTB-1705 "g"   "g"   "c"   "t"   "g"  </span></span>
<span><span class="co">## BTB-175  "a"   "t"   "t"   "c"   "g"  </span></span>
<span><span class="co">## BTB-1774 "a"   "t"   "t"   "c"   "g"  </span></span>
<span><span class="co">## BTB-262  "g"   "g"   "c"   "c"   "g"  </span></span>
<span><span class="co">## BTB-604  "g"   "g"   "c"   "c"   "g"  </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $lineage1_cluster7</span></span>
<span><span class="co">##          [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]</span></span>
<span><span class="co">## BTB-1332 "a"  "c"  "g"  "t"  "c"  "c"  "c"  "g"  "a"  "t"   "t"   "c"   "a"  </span></span>
<span><span class="co">## BTB-1645 "a"  "c"  "g"  "t"  "t"  "a"  "c"  "t"  "a"  "t"   "t"   "c"   "g"  </span></span>
<span><span class="co">## BTB-584  "a"  "c"  "g"  "t"  "c"  "c"  "c"  "g"  "a"  "t"   "t"   "g"   "a"  </span></span>
<span><span class="co">## BTB-640  "a"  "c"  "g"  "t"  "c"  "c"  "c"  "g"  "g"  "c"   "t"   "c"   "g"  </span></span>
<span><span class="co">## BTB-665  "a"  "c"  "g"  "t"  "c"  "c"  "g"  "g"  "a"  "t"   "a"   "c"   "a"  </span></span>
<span><span class="co">##          [,14]</span></span>
<span><span class="co">## BTB-1332 "g"  </span></span>
<span><span class="co">## BTB-1645 "g"  </span></span>
<span><span class="co">## BTB-584  "g"  </span></span>
<span><span class="co">## BTB-640  "a"  </span></span>
<span><span class="co">## BTB-665  "g"</span></span></code></pre>
<p>The output of this function is a list of matrices, where each matrix
is a cluster of sequences. We will use these to write into the xml file
to run BEAST2. If you are not using the template xml file available with
this package, you should save these sequences as fasta files to be
loaded into BEAUti, which you can do by providing a
<code>fasta_dir</code> argument to the above function.</p>
<p>After running the above chunks, we have two objects:
<code>cluster_assignments</code>, a list of lineages each containing a
dataframe giving sample IDs, cluster names, and collection dates; and
<code>snp_matrices</code>, a list of lineages each containing a list of
matrices, where each matrix is a cluster of sequences.</p>
</div>
<div class="section level2">
<h2 id="creating-xml-files-for-beast2">Creating XML Files for BEAST2<a class="anchor" aria-label="anchor" href="#creating-xml-files-for-beast2"></a>
</h2>
<p>For each cluster, we will create an xml file for BEAST2. In general,
BEAUti is used to create xml files for BEAST2, but here we are using a
model that should be mostly the same across all clusters. For the TB
data, this package comes with a template xml and the function
<code>create_cluster_xml</code> that will fill in the necessary
information for each cluster. The model associated with this xml
template:</p>
<ul>
<li>Strict clock model</li>
<li>HKY substitution model</li>
<li>Coalescent constant population tree prior</li>
<li>Uniform clock rate prior, user-supplied bounds</li>
<li>Log-normal(1, 1.25) (w/ upper bound of 1) frequency parameter</li>
<li>Log-normal(1, 1.25) transition-transversion parameter for HKY
(kappa)</li>
<li>Log-normal(1, 1.25) coalescent population size parameter</li>
</ul>
<p>The function to create the xml files requires the sequences (SNPs,
for us) for the cluster, the name of the cluster, the sampling dates for
the sequences in the cluster, and a directory to output the xml files
to.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For each lineage, write the xml files for all clusters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">snp_matrices</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">lineage_index</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get list of clusters for the lineage</span></span>
<span>  <span class="va">lineage_seqs</span> <span class="op">&lt;-</span> <span class="va">snp_matrices</span><span class="op">[[</span><span class="va">lineage_index</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co"># Get cluster assignments data frame for the lineage</span></span>
<span>  <span class="va">cluster_assignments_lineage</span> <span class="op">&lt;-</span> <span class="va">cluster_assignments</span><span class="op">[[</span><span class="va">lineage_index</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/create_xml_files.html">create_xml_files</a></span><span class="op">(</span>seqs_list <span class="op">=</span> <span class="va">lineage_seqs</span>,</span>
<span>                   cluster_assignments <span class="op">=</span> <span class="va">cluster_assignments_lineage</span>,</span>
<span>                   out_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mcc_trees_example"</span>, <span class="st">"BEAST2"</span>,</span>
<span>                                         package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The function above does not return anything, but it writes xml files
to the directory specified in <code>out_dir</code>. Messages are printed
when each xml file is written.</p>
</div>
<div class="section level2">
<h2 id="running-beast2">Running BEAST2<a class="anchor" aria-label="anchor" href="#running-beast2"></a>
</h2>
<p>Next, we will run BEAST2 on the xml files we just created. We will
use the <code>run_beast2</code> function, which calls command-line
BEAST2 using <code>system</code>. You may need to change the
<code>beast2_path</code> argument depending on which version of BEAST2
you have installed and where it is installed to.</p>
<p>Below I have parallelized the code using the <code>parallel</code>
package. This is not necessary, but it can speed up the process if you
have multiple cores available. Note that this will not work on Windows,
but there are other ways to parallelize on Windows machines.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">input_xml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mcc_trees_example"</span>, <span class="st">"BEAST2"</span>,</span>
<span>                                    package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                        pattern <span class="op">=</span> <span class="st">"\\.xml"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">input_xml</span>, <span class="va">run_beast2</span>, mc.cores <span class="op">=</span> <span class="va">cores</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>After running BEAST2, for each cluster, we will have a log file and a
tree file. The log file logs the MCMC sampling process, and the tree
file contains the posterior trees. First, as a quick check for the
mixing of the MCMC, we can make sure the effective sample size (ESS) is
above 200 for all parameters. We can do this using the
<code>ess_checks</code> function, which calls on the package
<code>tracerer</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beast_logs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mcc_trees_example"</span>, <span class="st">"BEAST2"</span>,</span>
<span>                                     package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                         pattern <span class="op">=</span> <span class="st">"\\.log"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">beast_logs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/ess_checks.html">ess_checks</a></span><span class="op">(</span><span class="st">"BEAST2"</span>, <span class="va">log</span>, min_ess <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span></code></pre>
<pre><code><span><span class="co">## lineage4_cluster183.log:</span></span>
<span><span class="co">## ESS is too low for 2 parameters</span></span></code></pre>
<pre><code><span><span class="co">##  ESS: 117    ESS: 162</span></span></code></pre>
<pre><code><span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span>
<span><span class="co">## All ESS are above minimum threshold</span></span></code></pre>
<p>If the ESS is too low, you may want to consider re-running BEAST2
with more iterations. Be sure also to look at traceplots of the MCMC
run, which is easiest to do with <code>Tracer</code>.</p>
</div>
<div class="section level2">
<h2 id="subsampling-beast2-iterations">Subsampling BEAST2 Iterations<a class="anchor" aria-label="anchor" href="#subsampling-beast2-iterations"></a>
</h2>
<p>This is where this tutorial diverges from the MCC trees tutorial.
Here, we will subsample some number of trees from the BEAST2 runs, and
run TransPhylo on the entire subsample for each cluster. This is
computationally expensive, so it is best to run this on a computing
cluster in parallel.</p>
<p>The reason to do this over using the MCC tree is to account for some
of the phylogenetic uncertainty in the BEAST2 trees. The MCC tree
functions as a summary of the posterior trees, but it is not the true
phylogenetic tree. By running TransPhylo on a subsample of the trees, we
can account for some of this uncertainty.</p>
<p>First, we use the <code>sample_BEAST2_trees</code> function to sample
100 trees from each BEAST2 run.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beast_trees_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mcc_trees_example"</span>, <span class="st">"BEAST2"</span>,</span>
<span>                                            package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                                pattern <span class="op">=</span> <span class="st">"\\.trees"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beast_trees_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">beast_trees_files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">trees_file</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sample_BEAST2_trees.html">sample_BEAST2_trees</a></span><span class="op">(</span><span class="va">trees_file</span>, n_trees <span class="op">=</span> <span class="fl">100</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>For each cluster, this gives us:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.amazon.com/Integration-Manipulation-Visualization-Phylogenetic-Computational-ebook/dp/B0B5NLZR1Z/" class="external-link">ggtree</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ggtree v3.14.0 Learn more at https://yulab-smu.top/contribution-tree-data/</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Please cite:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Guangchuang Yu, David Smith, Huachen Zhu, Yi Guan, Tommy Tsan-Yuk Lam.</span></span>
<span><span class="co">## ggtree: an R package for visualization and annotation of phylogenetic</span></span>
<span><span class="co">## trees with their covariates and other associated data. Methods in</span></span>
<span><span class="co">## Ecology and Evolution. 2017, 8(1):28-36. doi:10.1111/2041-210X.12628</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beast_trees_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 100 phylogenetic trees</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the first cluster's tree sample</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html" class="external-link">ggtree</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/theme_tree2.html" class="external-link">theme_tree2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plots</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">plots</span>, ncol <span class="op">=</span> <span class="fl">10</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="tree_sample_pipeline_files/figure-html/beast_trees_preview-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="running-transphylo-on-the-subsampled-trees">Running TransPhylo on the Subsampled Trees<a class="anchor" aria-label="anchor" href="#running-transphylo-on-the-subsampled-trees"></a>
</h2>
<p>Now that we have a subsample of trees for each cluster, we can run
TransPhylo on each cluster. In the MCC trees tutorial, we ran the
function <code>run_TransPhylo</code> only once; here, we will run it
once for each cluster.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make sure the tree names match the cluster dictionary names</span></span>
<span><span class="co"># By naming them after the files they came from, then removing the</span></span>
<span><span class="co"># file extension &amp; extras that BEAST2 adds to the filenames</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".trees"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">beast_trees_files</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*-"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all cluster assignments in one data frame</span></span>
<span><span class="va">all_cluster_assignments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">cluster_assignments</span><span class="op">)</span></span>
<span><span class="co"># Run TransPhylo on the tree samples in parallel</span></span>
<span><span class="co"># (I'm using the same number of cores as clusters)</span></span>
<span><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">trees_sample_index</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/run_TransPhylo.html">run_TransPhylo</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">[[</span><span class="va">trees_sample_index</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                 cluster_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span><span class="op">[</span><span class="va">trees_sample_index</span><span class="op">]</span>,</span>
<span>                 type <span class="op">=</span> <span class="st">"trees_sample"</span>,</span>
<span>                 cluster_dict <span class="op">=</span> <span class="va">all_cluster_assignments</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"tree_sample_example"</span>,</span>
<span>                                       <span class="st">"TransPhylo"</span>,</span>
<span>                                       package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                 output_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tp_res_"</span>,</span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beast_trees_list</span><span class="op">)</span><span class="op">[</span><span class="va">trees_sample_index</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                 w.shape <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                 w.scale <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                 prior_pi_a <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 prior_pi_b <span class="op">=</span> <span class="fl">19</span>,</span>
<span>                 startNeg <span class="op">=</span> <span class="fl">1.48</span>,</span>
<span>                 mcmcIterations <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span></span>
<span><span class="op">}</span>, mc.cores <span class="op">=</span> <span class="va">cores</span><span class="op">)</span></span></code></pre></div>
<p>The code above will save both the TransPhylo result itself and the
posterior probabilities for each cluster. The TransPhylo results are
large RDS files, so they are not included with the package. The infector
probabilities are saved in the <code>tree_sample_example</code>
directory in the package.</p>
<blockquote>
<p><strong>Note</strong>: A couple of the clusters did not run
successfully, so those have been excluded from the below results. Why
this happened should be further explored when time permits.</p>
</blockquote>
<p>We can look at the distribution of assigned probabilities, as in the
MCC trees tutorial:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read in prob_source files</span></span>
<span><span class="va">prob_source_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"trees_sample_example"</span>,</span>
<span>                                            <span class="st">"TransPhylo"</span>,</span>
<span>                                            package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span>,</span>
<span>                                full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">prob_source_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">prob_source_files</span>, <span class="va">readRDS</span><span class="op">)</span></span>
<span><span class="va">prob_source</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">prob_source_list</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">prob_source</span><span class="op">$</span><span class="va">prob</span>, main <span class="op">=</span> <span class="st">"Distribution of TransPhylo Probabilities"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Probability of being an infector"</span>, col <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tree_sample_pipeline_files/figure-html/prob_distribution-1.png" width="700"></p>
<p>And directly compare the assigned probabilities with a
scatterplot:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_source_mcc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mcc_trees_example"</span>, <span class="st">"TransPhylo"</span>,</span>
<span>                                       <span class="st">"tp_res_prob_source.rds"</span>,</span>
<span>                                       package <span class="op">=</span> <span class="st">"beast2tpPipeline"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prob_source_mcc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SampleID"</span>, <span class="st">"prob_source_mcc"</span><span class="op">)</span></span>
<span><span class="va">prob_source_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">prob_source</span>, <span class="va">prob_source_mcc</span>, by <span class="op">=</span> <span class="st">"SampleID"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">prob_source_pairs</span><span class="op">$</span><span class="va">prob_source</span>, <span class="va">prob_source_pairs</span><span class="op">$</span><span class="va">prob_source_mcc</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Prob Source Using BEAST2 Tree Sample Method (100 Trees)"</span>, ylab <span class="op">=</span> <span class="st">"Prob Source Using BEAST2 MCC Trees"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Comparison of TransPhylo Probabilities of Being an Infection Source"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span></span>
<span><span class="va">spline_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">prob_source_pairs</span><span class="op">$</span><span class="va">prob_source</span>,</span>
<span>              <span class="va">prob_source_pairs</span><span class="op">$</span><span class="va">prob_source_mcc</span>,</span>
<span>              spar <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">spline_fit</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="tree_sample_pipeline_files/figure-html/prob_source_scatterplot-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="regression-with-transphylo-results">Regression with TransPhylo Results<a class="anchor" aria-label="anchor" href="#regression-with-transphylo-results"></a>
</h2>
<p>As in the MCC tree pipeline, we can regress the probabilities
assigned by TransPhylo on some covariates. Here we will use the Bayesian
method of handling misclassification.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get dataframe with covariates for regression, add age and gender;</span></span>
<span><span class="co"># for this method, ensure all are numeric</span></span>
<span><span class="va">cleaned_data</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SampleID"</span>, <span class="st">"hivfinal_new"</span>, <span class="st">"genderf1"</span>,</span>
<span>                             <span class="st">"tb_everf3"</span>, <span class="st">"smokef1"</span>, <span class="st">"alcohol_excess"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">cleaned_data</span> <span class="op">&lt;-</span> <span class="va">cleaned_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">cleaned_data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">cleaned_data</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cleaned_data</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">2</span>,</span>
<span>                             <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">samples_logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regression.html">regression</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"bayesian_logistic_misclass"</span>,</span>
<span>                               cleaned_data <span class="op">=</span> <span class="va">cleaned_data</span>,</span>
<span>                               prob_source <span class="op">=</span> <span class="va">prob_source</span>,</span>
<span>                               prob_cutoff <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>                               sensitivity <span class="op">=</span> <span class="fl">0.28</span>,</span>
<span>                               specificity <span class="op">=</span> <span class="fl">0.97</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Gradient evaluation took 7.7e-05 seconds</span></span>
<span><span class="co">## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.77 seconds.</span></span>
<span><span class="co">## Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1:  Elapsed Time: 0.448 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 1:                0.418 seconds (Sampling)</span></span>
<span><span class="co">## Chain 1:                0.866 seconds (Total)</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: Gradient evaluation took 3.6e-05 seconds</span></span>
<span><span class="co">## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.36 seconds.</span></span>
<span><span class="co">## Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2:  Elapsed Time: 0.426 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 2:                0.46 seconds (Sampling)</span></span>
<span><span class="co">## Chain 2:                0.886 seconds (Total)</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: Gradient evaluation took 3.5e-05 seconds</span></span>
<span><span class="co">## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.35 seconds.</span></span>
<span><span class="co">## Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3:  Elapsed Time: 0.427 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 3:                0.467 seconds (Sampling)</span></span>
<span><span class="co">## Chain 3:                0.894 seconds (Total)</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: Gradient evaluation took 5.8e-05 seconds</span></span>
<span><span class="co">## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.58 seconds.</span></span>
<span><span class="co">## Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4:  Elapsed Time: 0.433 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 4:                0.447 seconds (Sampling)</span></span>
<span><span class="co">## Chain 4:                0.88 seconds (Total)</span></span>
<span><span class="co">## Chain 4:</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pull the samples for the hiv coefficient, which are the log adjusted</span></span>
<span><span class="co"># odds ratios (AORs) for the logistic regression</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">samples_logistic</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.7479  0.9852  1.0217  1.2920  1.3923  2.3130</span></span></code></pre>
<p>And we can compare these posterior AOR samples to those obtained
using the MCC trees method:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples_logistic_mcc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regression.html">regression</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"bayesian_logistic_misclass"</span>,</span>
<span>                                   cleaned_data <span class="op">=</span> <span class="va">cleaned_data</span>,</span>
<span>                                   prob_source <span class="op">=</span> <span class="va">prob_source</span>,</span>
<span>                                   prob_cutoff <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>                                   sensitivity <span class="op">=</span> <span class="fl">0.28</span>,</span>
<span>                                   specificity <span class="op">=</span> <span class="fl">0.97</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Gradient evaluation took 4.1e-05 seconds</span></span>
<span><span class="co">## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.41 seconds.</span></span>
<span><span class="co">## Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1:  Elapsed Time: 0.421 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 1:                0.484 seconds (Sampling)</span></span>
<span><span class="co">## Chain 1:                0.905 seconds (Total)</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: Gradient evaluation took 3.5e-05 seconds</span></span>
<span><span class="co">## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.35 seconds.</span></span>
<span><span class="co">## Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## Chain 2:  Elapsed Time: 0.424 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 2:                0.444 seconds (Sampling)</span></span>
<span><span class="co">## Chain 2:                0.868 seconds (Total)</span></span>
<span><span class="co">## Chain 2: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: Gradient evaluation took 3.5e-05 seconds</span></span>
<span><span class="co">## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.35 seconds.</span></span>
<span><span class="co">## Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## Chain 3:  Elapsed Time: 0.426 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 3:                0.446 seconds (Sampling)</span></span>
<span><span class="co">## Chain 3:                0.872 seconds (Total)</span></span>
<span><span class="co">## Chain 3: </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: Gradient evaluation took 3.6e-05 seconds</span></span>
<span><span class="co">## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.36 seconds.</span></span>
<span><span class="co">## Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 4: </span></span>
<span><span class="co">## Chain 4:  Elapsed Time: 0.415 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 4:                0.452 seconds (Sampling)</span></span>
<span><span class="co">## Chain 4:                0.867 seconds (Total)</span></span>
<span><span class="co">## Chain 4:</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pull the samples for the exponentiated coef and compare</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">samples_logistic</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">samples_logistic_mcc</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>,</span>
<span>        names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tree Sample Method"</span>, <span class="st">"MCC Trees Method"</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Comparison of Posterior AOR Samples"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Adjusted Odds Ratio of Transmission of TB with/without HIV"</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lightblue"</span>, <span class="st">"lightgreen"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tree_sample_pipeline_files/figure-html/regression_comparison-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jessalyn Sebastian.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
